# =============================================================================
#
# ============================================================================= 

FROM golang:1.15-alpine3.12
MAINTAINER Rohit Kumar <rohitupadhyay.upadhyay1@gmail.com> 

# ----------------------------------------------------------------------------
# Create new user and group
# ----------------------------------------------------------------------------

RUN adduser -D -g 'alpine' alpine

# ----------------------------------------------------------------------------
# Install 
# ----------------------------------------------------------------------------

RUN apk update

# ----------------------------------------------------------------------------- 
# Copy content 
# ----------------------------------------------------------------------------- 

RUN mkdir /opt/api/
COPY . /opt/api/
COPY startup.sh /opt/api/

# ----------------------------------------------------------------------------- 
# Change owner and permission 
# ----------------------------------------------------------------------------- 

RUN chown -R alpine:alpine /opt/api/
RUN chmod +x /opt/api/startup.sh
 
# ----------------------------------------------------------------------------- 
# Switch user
# ----------------------------------------------------------------------------- 

USER alpine
WORKDIR /opt/api/

# ----------------------------------------------------------------------------- 
# Install libraries 
# ----------------------------------------------------------------------------- 

RUN go mod download


# ----------------------------------------------------------------------------- 
# Install Swag
# ----------------------------------------------------------------------------- 
#RUN go get -u github.com/swaggo/swag/cmd/swag


# ----------------------------------------------------------------------------- 
# Swag Initialize # Generate Swagger Doc
# ----------------------------------------------------------------------------- 
#RUN swag init -g server.go

# ----------------------------------------------------------------------------- 
# Create build 
# ----------------------------------------------------------------------------- 

RUN go build -o ./out/addressbook .

# ----------------------------------------------------------------------------- 
# Remove extra files 
# ----------------------------------------------------------------------------- 

RUN rm -rf Dockerfile .git/

# ----------------------------------------------------------------------------- 
# Set ports 
# ----------------------------------------------------------------------------- 

EXPOSE 8900

CMD /opt/api/startup.sh

#ENTRYPOINT ["tail", "-f", "/dev/null"]


